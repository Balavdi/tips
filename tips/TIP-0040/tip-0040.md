---
tip: 40
title: Staking & Delegation
description: Staking, Delegation and Mana Rewards
author: TODO
discussions-to: TODO
status: Draft
type: Standards
layer: Core
created: 2023-05-03
requires: TIP-19, TIP-20, TIP-21 and TIP-22
---

# Table of Contents

1. [Summary](#summary)
2. [Motivation](#motivation)
3. [Building Blocks](#building-blocks)
4. [Staking](#staking)
5. [Delegation](#delegation)
   - [Delegation Output](#delegation-output)
   - [Storage Deposit](#storage-deposit-calculation)
6. [Mana Rewards](#mana-rewards)
   - [Validator Rewards](#validator-rewards)
   - [Delegation Rewards](#delegation-rewards)
7. [Copyright](#copyright)

# Summary

Staking and Delegation are a mechanism by which users contribute to the security of the network for which they are
rewarded. Stakers lock IOTA tokens in order to become eligible to be selected into the validator committee. Delegators
delegate IOTA tokens to a validator, forming a validator pool. Such a pool votes on conflicts and derives it voting
weight from the locked tokens of the staker and the delegated tokens of all its delegators. If the validator of a pool
performs its task well, the pool is rewarded with Mana. Each participant of the pool can claim rewards roughly
proportional to the amount of staked or delegated tokens. This results in a mechanism that incentivizes users to
contribute to the security and well-functioning of the network while receiving rewards for their contribution.

This TIP specifies the details of staking, delegation, committee selection, validation and Mana rewards.

# Motivation

TODO

# Building Blocks

## Data Types & Subschema Notation

Data types and subschemas used throughout this TIP are defined in [TIP-21](../TIP-0021/tip-0021.md).

## Global Protocol Parameters

Global protocol parameters used throughout this TIP are defined in [TIP-22 (IOTA)](../TIP-0022/tip-0022.md) and
[TIP-32 (Shimmer)](../TIP-0032/tip-0032.md).

## Transaction Payload

[TIP-45](../TIP-0045/tip-0045.md) is the basis for output validation in this TIP.

## Common Parameters and Functions

- Let `Current Transaction Epoch Index` be the index of the epoch to which the transaction belongs.
- Let `decay(n)` be calculated with the algorithm and lookup table in [TIP-39](../TIP-0039/tip-0039.md).

# Staking

The IOTA protocol accepts blocks and transactions through voting. The voters are a selected validator committee. The
following gives a high-level idea of the selection process, with the details specified in the rest of the section.

Stakers, or interchangeably also called _registered validators_, get voting weight by locking IOTA tokens. By locking
the tokens, the stakers prove control over them so the protocol assigns them a proportional amount of voting weight in
exchange. Additionally, other users - so-called delegators - can _delegate_ their IOTA tokens to a staker to increase
its voting weight further. A staker and all its delegators are called a staking or validator pool. Such a pool is
eligible to be selected into a committee for a certain duration. Only the _Witness Weight_, used for the acceptance of
blocks, and _Approval Weight_, used for conflict resolution and transaction acceptance, of those selected into the
committee is considered to determine the ledger state.

The IOTA protocol slices time into slots and epochs. An epoch is simply a number of slots, and a slot has a
protocol-defined duration in seconds. A new validator committee is selected for each epoch. Shortly before an epoch
ends, the current activity of all registered validators as well as the pool's stake is determined. Through a selection
procedure, a committee is selected out of all the registered pools who have a large enough voting power and enough block
issuance activity. Once selected, it is each pool's responsibility to issue _Validation Blocks_ across the epoch through
which they vote on conflicts. Depending on how many such blocks they issued for each slot in an epoch and how many they
were expected to issue, a _performance factor_ is calculated. This factor determines the amount of _Mana rewards_ the
validator's pool receives.

After an epoch ends, the delegators of the pool can claim their rewards. The validator may continue to stake or end its
stake by going through an unbonding period of its locked tokens. After this period ends, the validator can unlock their
IOTA tokens and claim their Mana rewards.

## Registration

Accounts are considered registered for validaton if they have a _Staking Feature_ in their _Features_. This feature and
its transaction validation rules are specified in [TIP-42](../TIP-0042/tip-0042.md).

## Committee Selection

![](./assets/selection-timing.png)

_This figures gives an overview of the timing around committee selection in epochs. Note that the exact length of those
windows is not accurately depicted here and instead depends on the value of the corresponding Protocol Parameters._

To select a committee for an epoch with epoch index `n`, whose first slot index is denoted by `Epoch Start Slot(n)`, the
following steps must be taken.

- Let `Registration Slot(n)` be the registration slot with index
  `Epoch Start Slot(n) - Epoch Nearing Threshold - Activity Window Duration - 1`.
- Let `Activity Window Slot(n)` be the last slot of the activity window with index
  `Epoch Start Slot(n) - Epoch Nearing Threshold - 1`.
- Let `Cutoff Slot(n)` be the slot with index `Epoch Start Slot(n) - Maximum Committable Age - 1`.
- The set of _registered validators_ are all account outputs satisfying all of the following conditions:
  - The account has a _Staking Feature_ at the end of the `Registration Slot(n)`.
  - The account's Staking Feature's `End Epoch` is greater or equal to `n`.
- For any validator `i` in the set of _registered validators_ the activity is determined. The validator is active if the
  following condition holds, otherwise it is inactive:
  - The account with `Account ID` issues at least one block whose `Account ID` field is equal to that of the account,
    and the block's `Issuing Time` field converted to a slot index `Block Slot Index`, satisfies all of the following
    conditions:
    - `Block Slot Index > Registration Slot(n)`.
    - `Block Slot Index <= Activity Window Slot(n)`.
- For any validator `i` in the set of _registered validators_ the voting power is equal to `Stake_i + DelegatedStake_i`
  at the end of the slot with index `Registration Slot(n)`, where:
  - `Stake_i` is the `Staked Amount` of IOTA tokens of the validator's _Staking Feature_.
  - `DelegatedStake_i` is the sum of all _Delegation Output's_ `Amount` field where the value of the `Validator ID`
    field is equal to `i`.
- The set of _registered validators_ who are active constitute the set of _eligible validators_, which is sorted by
  voting power in descending order. The first `Committee Size` entries in the _eligible validators_ set is the
  preliminary committee for Epoch `n`.
- The preliminary committee becomes the selected committee if the `Activity Window Slot(n)` is finalized before the
  `Cutoff Slot(n)` is committed, otherwise the committee of the current epoch becomes the selected committee of the next
  epoch.

### Committee Tasks

The selected members of the committee are expected to issue _Validation Blocks_, defined in
[TIP-46](../TIP-0046/tip-0046.md). Only the _Witness Weight_, used for the acceptance of blocks, and _Approval Weight_,
used for conflict resolution and transaction acceptance, of those selected into the committee is considered to determine
the ledger state. The [performance](#performance-factor) of a validator is determined through the issuance of Validation
Blocks and affects the validator pool's Mana rewards.

# Delegation

By delegating, a user adds voting weight in the form of IOTA tokens to a validator's voting power without having to
become a validator themself. In order to delegate, a _Delegation Output_ must be created. The following section
specifies how delegation is implemented.

## Delegation Output

Delegation is implemented with a special output type, the so-called Delegation Output.

Each Delegation output gets assigned a unique identifier `Delegation ID` upon creation by the protocol. `Delegation ID`
is the BLAKE2b-256 hash of the `Output ID` that created the Delegation Output.

<table>
    <details>
        <summary>Delegation Output</summary>
        <blockquote>
            Describes a Delegation output, which delegates its contained IOTA tokens as voting power to a validator.
        </blockquote>
        <table>
            <tr>
                <td><b>Name</b></td>
                <td><b>Type</b></td>
                <td><b>Description</b></td>
            </tr>
            <tr>
                <td>Output Type</td>
                <td>uint8</td>
                <td>
                    Set to <strong>value 7</strong> to denote a <i>Delegation Output</i>.
                </td>
            </tr>
            <tr>
                <td>Amount</td>
                <td>uint64</td>
                <td>The amount of IOTA coins held by the output.</td>
            </tr>
            <tr>
                <td>Delegated Amount</td>
                <td>uint64</td>
                <td>The amount of delegated IOTA coins.</td>
            </tr>
            <tr>
                <td>Delegation ID</td>
                <td>ByteArray[32]</td>
                <td>Unique identifier of the Delegation Output, which is the BLAKE2b-256 hash of the <i>Output ID</i> that created it.</td>
            </tr>
            <tr>
                <td>Validator ID</td>
                <td>ByteArray[32]</td>
                <td>The <i>Account ID</i> of the validator to which this output is delegating.</td>
            </tr>
            <tr>
                <td>Start Epoch</td>
                <td>uint64</td>
                <td>The index of the first epoch for which this output delegates.</td>
            </tr>
            <tr>
                <td>End Epoch</td>
                <td>uint64</td>
                <td>The index of the last epoch for which this output delegates.</td>
            </tr>
            <tr>
                <td>Unlock Conditions Count</td>
                <td>uint8</td>
                <td>The number of unlock conditions following.</td>
            </tr>
            <tr>
                <td valign="top">Unlock Conditions <code>atMostOneOfEach</code></td>
                <td colspan="2">
                    <details>
                        <summary>Address Unlock Condition</summary>
                        <table>
                            <tr>
                                <td><b>Name</b></td>
                                <td><b>Type</b></td>
                                <td><b>Description</b></td>
                            </tr>
                            <tr>
                                <td>Unlock Condition Type</td>
                                <td>uint8</td>
                                <td>
                                    Set to <strong>value 0</strong> to denote an <i>Address Unlock Condition</i>.
                                </td>
                            </tr>
                            <tr>
                                <td>Address</td>
                                <td colspan="2">
                                    <details>
                                        <summary>Ed25519 Address</summary>
                                        <table>
                                            <tr>
                                                <td><b>Name</b></td>
                                                <td><b>Type</b></td>
                                                <td><b>Description</b></td>
                                            </tr>
                                            <tr>
                                                <td>Address Type</td>
                                                <td>uint8</td>
                                                <td>
                                                    Set to <strong>value 0</strong> to denote an <i>Ed25519 Address</i>.
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>PubKeyHash</td>
                                                <td>ByteArray[32]</td>
                                                <td>The raw bytes of the Ed25519 address which is a BLAKE2b-256 hash of the Ed25519 public key.</td>
                                            </tr>
                                        </table>
                                    </details>
                                    <details>
                                        <summary>Alias Address</summary>
                                        <table>
                                            <tr>
                                                <td><b>Name</b></td>
                                                <td><b>Type</b></td>
                                                <td><b>Description</b></td>
                                            </tr>
                                            <tr>
                                                <td>Address Type</td>
                                                <td>uint8</td>
                                                <td>
                                                    Set to <strong>value 8</strong> to denote an <i>Alias Address</i>.
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Alias ID</td>
                                                <td>ByteArray[32]</td>
                                                <td>The raw bytes of the <i>Alias ID</i> which is the BLAKE2b-256 hash of the outputID that created it.</td>
                                            </tr>
                                        </table>
                                    </details>
                                    <details>
                                        <summary>NFT Address</summary>
                                        <table>
                                            <tr>
                                                <td><b>Name</b></td>
                                                <td><b>Type</b></td>
                                                <td><b>Description</b></td>
                                            </tr>
                                            <tr>
                                                <td>Address Type</td>
                                                <td>uint8</td>
                                                <td>
                                                    Set to <strong>value 16</strong> to denote an <i>NFT Address</i>.
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>NFT ID</td>
                                                <td>ByteArray[32]</td>
                                                <td>The raw bytes of the <i>NFT ID</i> which is the BLAKE2b-256 hash of the outputID that created it.</td>
                                            </tr>
                                        </table>
                                    </details>
                                </td>
                            </tr>
                        </table>
                    </details>
                </td>
            </tr>
            <tr>
                <td>Immutable Features Count</td>
                <td>uint8</td>
                <td>The number of immutable features following. Immutable features are defined upon deployment of the UTXO state machine and are not allowed to change in any future state transition.</td>
            </tr>
            <tr>
                <td valign="top">Immutable Features <code>atMostOneOfEach</code></td>
                <td colspan="2">
                    <details>
                        <summary>Issuer Feature</summary>
                        <blockquote>
                            Identifies the validated issuer of the UTXO state machine.
                        </blockquote>
                        <table>
                            <tr>
                                <td><b>Name</b></td>
                                <td><b>Type</b></td>
                                <td><b>Description</b></td>
                            </tr>
                            <tr>
                                <td>Feature Type</td>
                                <td>uint8</td>
                                <td>
                                    Set to <strong>value 1</strong> to denote an <i>Issuer Feature</i>.
                                </td>
                            </tr>
                            <tr>
                                <td valign="top">Issuer <code>oneOf</code></td>
                                <td colspan="2">
                                    <details>
                                        <summary>Ed25519 Address</summary>
                                        <table>
                                            <tr>
                                                <td><b>Name</b></td>
                                                <td><b>Type</b></td>
                                                <td><b>Description</b></td>
                                            </tr>
                                            <tr>
                                                <td>Address Type</td>
                                                <td>uint8</td>
                                                <td>
                                                    Set to <strong>value 0</strong> to denote an <i>Ed25519 Address</i>.
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>PubKeyHash</td>
                                                <td>ByteArray[32]</td>
                                                <td>The raw bytes of the Ed25519 address which is a BLAKE2b-256 hash of the Ed25519 public key.</td>
                                            </tr>
                                        </table>
                                    </details>
                                    <details>
                                        <summary>Alias Address</summary>
                                        <table>
                                            <tr>
                                                <td><b>Name</b></td>
                                                <td><b>Type</b></td>
                                                <td><b>Description</b></td>
                                            </tr>
                                            <tr>
                                                <td>Address Type</td>
                                                <td>uint8</td>
                                                <td>
                                                    Set to <strong>value 8</strong> to denote an <i>Alias Address</i>.
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Alias ID</td>
                                                <td>ByteArray[32]</td>
                                                <td>The raw bytes of the <i>Alias ID</i> which is the BLAKE2b-256 hash of the outputID that created it.</td>
                                            </tr>
                                        </table>
                                    </details>
                                    <details>
                                        <summary>NFT Address</summary>
                                        <table>
                                            <tr>
                                                <td><b>Name</b></td>
                                                <td><b>Type</b></td>
                                                <td><b>Description</b></td>
                                            </tr>
                                            <tr>
                                                <td>Address Type</td>
                                                <td>uint8</td>
                                                <td>
                                                    Set to <strong>value 16</strong> to denote an <i>NFT Address</i>.
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>NFT ID</td>
                                                <td>ByteArray[32]</td>
                                                <td>The raw bytes of the <i>NFT ID</i> which is the BLAKE2b-256 hash of the outputID that created it.</td>
                                            </tr>
                                        </table>
                                    </details>
                                </td>
                            </tr>
                        </table>
                    </details>
                </td>
            </tr>
        </table>
    </details>
</table>

### Additional Transaction Syntactic Validation Rules

#### Output Syntactic Validation

- `Amount` field must fulfill the dust protection requirements and must not be `0`.
- `Amount` field must be ≤ `Max IOTA Supply`.
- It must hold true that `1` ≤ `Unlock Conditions Count` ≤ `1`.
- `Unlock Condition Type` of an <i>Unlock Condition</i> must define one of the following types:
  - <i>Address Unlock Condition</i>
- <i>Unlock Conditions</i> must be sorted in ascending order based on their `Unlock Condition Type`.
- Syntactic validation of all present unlock conditions must pass.
- <i>Address Unlock Condition</i> must be present.
- It must hold true that `0` ≤ `Immutable Features Count` ≤ `1`.
- `Feature Type` of a <i>Feature</i> in `Immutable Features` must define one of the following types:
  - <i>Issuer Feature</i>
- <i>Features</i> must be sorted in ascending order based on their `Feature Type` both in the `Immutable Features`
  fields.
- Syntactic validation of all present features must pass.
- `Validator ID` must not be zeroed out.

### Additional Transaction Semantic Validation Rules

- Explicit `Delegation ID`: `Delegation ID` is taken as the value of the `Delegation ID` field in the Delegation output.
- Implicit `Delegation ID`: When a Delegation output is consumed as an input in a transaction and `Delegation ID` field
  is zeroed out, take the BLAKE2b-256 hash of the `Output ID` of the input as `Delegation ID`.
- For every non-zero explicit `Delegation ID` on the output side there must be a corresponding Delegation Output on the
  input side. The corresponding Delegation output has the explicit or implicit `Delegation ID` equal to that of the
  Delegation output on the output side.

#### Consumed Outputs

Whenever a Delegation output is consumed in a transaction, it means that the output is transitioned into its next state.
From its initial state, the _Delegating State_, a Delegation Output can either be destroyed or transitioned to a
_Delayed Claiming_ state, from which it can then be destroyed. The current state is defined as the consumed Delegation
output, while the next state is defined as the Delegation output with the same explicit `Delegation ID` on the output
side. There are thus two types of transitions: delayed claiming transition and destruction transition.

- Delayed Claiming Transition
  - Is identified by a zeroed out `Delegation ID` on the input side and a non-zeroed out `Delegation ID` on the output
    side.
  - The fields `Delegated Amount`, `Start Epoch` and `Validator ID` must not be changed.
  - `End Epoch` on the output must be set as follows.
    - Let `Output Transition Slot Index` be the slot index of the transaction in which the Delegation Output is
      transitioned.
    - Let `Registration Slot(n)` be defined as in [committee selection](#committee-selection).
    - If `Output Transition Slot Index <= Registration Slot(n+1)` then `End Epoch` must be set to the epoch index
      resulting from the integer division of `Output Transition Slot Index / Epoch Slot Duration`, otherwise to
      `Output Transition Slot Index / Epoch Slot Duration + 1`.
- Destruction Transition
  - Is identified by the absence of a Delegation Output on the output side with an explicit `Delegation ID` that
    corresponds to the `Delegation ID` of the one on the input side, which may be an implicit or explicit Delegation ID.
    The next state is the empty state.
  - During this transition, Mana rewards may be added to the total sum of mana on the output side of the transaction,
    according to [delegation rewards](#delegation-rewards).

#### Created Outputs

- When `Delegation ID` is zeroed out certain fields of the Delegation Output must be set as follows.
  - Let `Output Creation Slot Index` be the slot index of the transaction in which the Delegation Output is created.
  - Let `Registration Slot(n)` be defined as in [committee selection](#committee-selection).
  - If `Output Creation Slot Index <= Registration Slot(n+1)` then `Start Epoch` must be set to the epoch index
    resulting from the integer division of `Output Creation Slot Index / Epoch Slot Duration + 1`, otherwise to
    `Output Creation Slot Index / Epoch Slot Duration + 2`.
  - Set `Delegated Amount` to the value of the `Amount` field.
  - Set `End Epoch` to `0`.

### Storage Deposit Calculation

The storage deposit of a Delegation Output is higher than for other output types. Therefore, the storage deposit
calculation of these outputs defines an additional corresponding field type.

<table>
    <tr>
        <th>Name</th>
        <th>Description</th>
        <th>Weight</th>
        <th>Reasoning</th>
    </tr>
    <tr>
        <td><code>delegation</code></td>
        <td>Fields contained in a <i>Delegation Output</i>.</td>
        <td>TODO: TBD</td>
        <td>Delegation requires additional bookkeeping in nodes for committee selection and mana rewards tracking.</td>
    </tr>
</table>

The following table shows the Delegation Output including the possible fields and their specific weight.

<table>
    <details>
        <summary>Delegation Output</summary>
        <blockquote>
            Describes a Delegation output, which delegates its contained IOTA tokens as voting power to a validator.
        </blockquote>
        <table>
            <tr>
                <td><b>Field</b></td>
                <td><b>Field type</b></td>
                <td><b>Length Minimum</b></td>
                <td><b>Length Maximum</b></td>
                <td><b>Description</b></td>
            </tr>
            <tr>
                <td>Output Type</td>
                <td><code>delegation</code></td>
                <td>1</td>
                <td>1</td>
                <td>
                    Set to <strong>value 7</strong> to denote a <i>Delegation Output</i>.
                </td>
            </tr>
            <tr>
                <td>Amount</td>
                <td><code>delegation</code></td>
                <td>8</td>
                <td>8</td>
                <td>The amount of IOTA coins held by the output.</td>
            </tr>
            <tr>
                <td>Delegated Amount</td>
                <td><code>delegation</code></td>
                <td>8</td>
                <td>8</td>
                <td>The amount of delegated IOTA coins.</td>
            </tr>
            <tr>
                <td>Delegation ID</td>
                <td><code>delegation</code></td>
                <td>32</td>
                <td>32</td>
                <td>Unique identifier of the Delegation Output, which is the BLAKE2b-256 hash of the <i>Output ID</i> that created it.</td>
            </tr>
            <tr>
                <td>Validator ID</td>
                <td><code>delegation</code></td>
                <td>32</td>
                <td>32</td>
                <td>The <i>Account ID</i> of the validator to which this output is delegating.</td>
            </tr>
            <tr>
                <td>Start Epoch</td>
                <td><code>delegation</code></td>
                <td>8</td>
                <td>8</td>
                <td>The index of the first epoch for which this output delegates.</td>
            </tr>
            <tr>
                <td>End Epoch</td>
                <td><code>delegation</code></td>
                <td>8</td>
                <td>8</td>
                <td>The index of the last epoch for which this output delegates.</td>
            </tr>
            <tr>
                <td>Unlock Conditions Count</td>
                <td><code>data</code></td>
                <td>1</td>
                <td>1</td>
                <td>The number of unlock conditions following.</td>
            </tr>
            <tr>
                <td valign="top">Unlock Conditions <code>atMostOneOfEach</code></td>
                <td colspan="2">
                    <details>
                        <summary>Address Unlock Condition</summary>
                        <table>
                            <tr>
                                <td><b>Name</b></td>
                                <td><b>Type</b></td>
                                <td><b>Description</b></td>
                            </tr>
                            <tr>
                                <td>Unlock Condition Type</td>
                                <td><code>data</code></td>
                                <td>1</td>
                                <td>1</td>
                                <td>
                                    Set to <strong>value 0</strong> to denote an <i>Address Unlock Condition</i>.
                                </td>
                            </tr>
                            <tr>
                                <td>Address</td>
                                <td colspan="2">
                                    <details>
                                        <summary>Ed25519 Address</summary>
                                        <table>
                                            <tr>
                                                <td><b>Name</b></td>
                                                <td><b>Field type</b></td>
                                                <td><b>Length Minimum</b></td>
                                                <td><b>Length Maximum</b></td>
                                                <td><b>Description</b></td>
                                            </tr>
                                            <tr>
                                                <td>Address Type</td>
                                                <td><code>data</code></td>
                                                <td>1</td>
                                                <td>1</td>
                                                <td>
                                                    Set to <strong>value 0</strong> to denote an <i>Ed25519 Address</i>.
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>PubKeyHash</td>
                                                <td><code>data</code></td>
                                                <td>32</td>
                                                <td>32</td>
                                                <td>The raw bytes of the Ed25519 address which is a BLAKE2b-256 hash of the Ed25519 public key.</td>
                                            </tr>
                                        </table>
                                    </details>
                                    <details>
                                        <summary>Account Address</summary>
                                        <table>
                                            <tr>
                                                <td><b>Name</b></td>
                                                <td><b>Field type</b></td>
                                                <td><b>Length Minimum</b></td>
                                                <td><b>Length Maximum</b></td>
                                                <td><b>Description</b></td>
                                            </tr>
                                            <tr>
                                                <td>Address Type</td>
                                                <td><code>data</code></td>
                                                <td>1</td>
                                                <td>1</td>
                                                <td>
                                                    Set to <strong>value 8</strong> to denote an <i>Account Address</i>.
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Account ID</td>
                                                <td><code>data</code></td>
                                                <td>32</td>
                                                <td>32</td>
                                                <td>The raw bytes of the <i>Account ID</i> which is the BLAKE2b-256 hash of the outputID that created it.</td>
                                            </tr>
                                        </table>
                                    </details>
                                    <details>
                                        <summary>NFT Address</summary>
                                        <table>
                                            <tr>
                                                <td><b>Name</b></td>
                                                <td><b>Field type</b></td>
                                                <td><b>Length Minimum</b></td>
                                                <td><b>Length Maximum</b></td>
                                                <td><b>Description</b></td>
                                            </tr>
                                            <tr>
                                                <td>Address Type</td>
                                                <td><code>data</code></td>
                                                <td>1</td>
                                                <td>1</td>
                                                <td>
                                                    Set to <strong>value 16</strong> to denote an <i>NFT Address</i>.
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>NFT ID</td>
                                                <td><code>data</code></td>
                                                <td>32</td>
                                                <td>32</td>
                                                <td>The raw bytes of the <i>NFT ID</i> which is the BLAKE2b-256 hash of the outputID that created it.</td>
                                            </tr>
                                        </table>
                                    </details>
                                </td>
                            </tr>
                        </table>
                    </details>
                </td>
            </tr>
            <tr>
                <td>Immutable Features Count</td>
                <td><code>data</code></td>
                <td>1</td>
                <td>1</td>
                <td>The number of immutable features following. Immutable features are defined upon deployment of the UTXO state machine and are not allowed to change in any future state transition.</td>
            </tr>
            <tr>
                <td valign="top">Immutable Features <code>atMostOneOfEach</code></td>
                <td colspan="2">
                    <details>
                    <summary>Issuer Feature</summary>
                    <blockquote>
                        Identifies the validated issuer of the UTXO state machine.
                    </blockquote>
                    <table>
                        <tr>
                            <td><b>Name</b></td>
                            <td><b>Field type</b></td>
                            <td><b>Length Minimum</b></td>
                            <td><b>Length Maximum</b></td>
                            <td><b>Description</b></td>
                        </tr>
                        <tr>
                            <td>Feature Type</td>
                            <td><code>data</code></td>
                            <td>1</td>
                            <td>1</td>
                            <td>
                                Set to <strong>value 1</strong> to denote an <i>Issuer Feature</i>.
                            </td>
                        </tr>
                        <tr>
                            <td valign="top">Issuer <code>oneOf</code></td>
                            <td colspan="2">
                                <details>
                                    <summary>Ed25519 Address</summary>
                                    <table>
                                        <tr>
                                            <td><b>Name</b></td>
                                            <td><b>Field type</b></td>
                                            <td><b>Length Minimum</b></td>
                                            <td><b>Length Maximum</b></td>
                                            <td><b>Description</b></td>
                                        </tr>
                                        <tr>
                                            <td>Address Type</td>
                                            <td><code>data</code></td>
                                            <td>1</td>
                                            <td>1</td>
                                            <td>
                                                Set to <strong>value 0</strong> to denote an <i>Ed25519 Address</i>.
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>PubKeyHash</td>
                                            <td><code>data</code></td>
                                            <td>32</td>
                                            <td>32</td>
                                            <td>The raw bytes of the Ed25519 address which is a BLAKE2b-256 hash of the Ed25519 public key.</td>
                                        </tr>
                                    </table>
                                </details>
                                <details>
                                    <summary>Account Address</summary>
                                    <table>
                                        <tr>
                                            <td><b>Name</b></td>
                                            <td><b>Field type</b></td>
                                            <td><b>Length Minimum</b></td>
                                            <td><b>Length Maximum</b></td>
                                            <td><b>Description</b></td>
                                        </tr>
                                        <tr>
                                            <td>Address Type</td>
                                            <td><code>data</code></td>
                                            <td>1</td>
                                            <td>1</td>
                                            <td>
                                                Set to <strong>value 8</strong> to denote an <i>Account Address</i>.
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Account ID</td>
                                            <td><code>data</code></td>
                                            <td>32</td>
                                            <td>32</td>
                                            <td>The raw bytes of the <i>Account ID</i> which is the BLAKE2b-256 hash of the outputID that created it.</td>
                                        </tr>
                                    </table>
                                </details>
                                <details>
                                    <summary>NFT Address</summary>
                                    <table>
                                        <tr>
                                            <td><b>Name</b></td>
                                            <td><b>Field type</b></td>
                                            <td><b>Length Minimum</b></td>
                                            <td><b>Length Maximum</b></td>
                                            <td><b>Description</b></td>
                                        </tr>
                                        <tr>
                                            <td>Address Type</td>
                                            <td><code>data</code></td>
                                            <td>1</td>
                                            <td>1</td>
                                            <td>
                                                Set to <strong>value 16</strong> to denote an <i>NFT Address</i>.
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>NFT ID</td>
                                            <td><code>data</code></td>
                                            <td>32</td>
                                            <td>32</td>
                                            <td>The raw bytes of the <i>NFT ID</i> which is the BLAKE2b-256 hash of the outputID that created it.</td>
                                        </tr>
                                    </table>
                                </details>
                            </td>
                        </tr>
                    </table>
                </details>
              </td>
            </tr>
        </table>
    </details>
</table>

# Mana Rewards

Mana Rewards are claimed and tracked for past epochs on an epoch level. For an ongoing epoch, they are tracked on a slot
level and are then combined into an epoch rewards entry when the epoch ends. Rewards for an epoch become claimable when
the epoch ends, that is, when its last slot is committed.

## Slot Level

For each slot, the performance factor of each validator in the selected committee must be tracked. For an epoch this
results in a list of performance factors for a validator. The rewards for an ongoing epoch are tracked by keeping a map
with `Validator ID`s as keys, of type `ByteArray[32]`, and the values being a list of objects consisting of these
fields:

<table>
    <tr>
        <td><b>Name</b></td>
        <td><b>Type</b></td>
        <td><b>Description</b></td>
    </tr>
    <tr>
        <td>Slot Index</td>
        <td><code>uint64</code></td>
        <td>The slot index for which the performance factor is tracked.</td>
    </tr>
    <tr>
        <td>Performance Factor</td>
        <td><code>uint8</code></td>
        <td>The performance factor of the validator.</td>
    </tr>
</table>

TODO: Do we have to state the following or can we just include it in the calculations?

Since the `Performance Factor` is a uint8, a right-shift of 8 bits should be later applied to the sum.

### Performance Factor

This performance factor for a slot is defined as follows.

- Let `Validation Blocks Issued` be the number of _Validation Blocks_ issued by a given validator in a slot.
- Then `Perfomance Factor` is given by ... TODO.

From the Draft TIP:

- Not issuing enough Validation blocks will decrease the validator rewards (and even completely decreasing the reward to
  zero), even if the same validator issued other block types.

## Epoch Level

### Epoch Rewards

The rewards of an epoch are tracked by keeping a map with `Validator ID`s as keys, of type `ByteArray[32]`, and the
values being a list of objects consisting of these fields:

<table>
    <tr>
        <td><b>Name</b></td>
        <td><b>Type</b></td>
        <td><b>Description</b></td>
    </tr>
    <tr>
        <td>Epoch Index</td>
        <td><code>uint64</code></td>
        <td>The epoch index for which the rewards can be claimed.</td>
    </tr>
    <tr>
        <td>Pool Stake</td>
        <td><code>uint64</code></td>
        <td>The total amount of IOTA tokens staked by the validator and all its delegators.</td>
    </tr>
    <tr>
        <td>Pool Rewards</td>
        <td>TODO: Decide on data type. <code>uint32</code></td>
        <td>The total amount of rewards the validator pool received, without the fixed cost of the validator.</td>
    </tr>
</table>

### Profit Margins

Additionally, the profit margins must be tracked for each epoch.

<table>
    <tr>
        <td><b>Name</b></td>
        <td><b>Type</b></td>
        <td><b>Description</b></td>
    </tr>
    <tr>
        <td>Epoch Index</td>
        <td>uint64</td>
        <td>
            The epoch index for which the profit margin is tracked.
        </td>
    </tr>
    <tr>
        <td>Profit Margin</td>
        <td>uint8</td>
        <td>
            An integer representing the epoch profit margin.
        </td>
    </tr>
</table>

### Slot-Epoch Conversion

The following section specifies how to convert the slot-level data into epoch-level data.

- The total target reward `Target Reward(n)` for a slot index `n` is defined as:
  - `233373068869021000 * decay(n)` if `n <= 9460800`.
  - `85853149583786000` if `n > 9460800`.
  - TODO: Is this index `9460800` relative to the start slot index of the IOTA 2.0 network, since it doesn't start at
    `1`?
- For each slot index `n` in the epoch, the rewards are calculated as follows.
  - Let `Performance Factor(n)` be the `Performance Factor` with slot index `n`.
  - Let `Validator Stake(i)` be the amount of IOTA tokens staked by the validator with Account ID `i`, i.e. the
    `Staked Amount` in the _Staking Feature_ of the validator.
  - Let `Pool Stake` be the total amount of delegated and staked IOTA tokens by the validator pool which was determined
    at the time of the voting power calculation. (TODO: Update after we've defined how we keep track of validators and
    their voting power in slot committments.)
  - Let `Total Stake` be the sum of all `Pool Stake` values, that is, the total amount of delegated and staked IOTA
    tokens in the selected committee.
  - Let `Total Validator Stake` be the sum of `Validator Stake(i)` for each validator `i` in the selected committee.
  - Let the `Profit Margin` be `2^8 * Total Validator Stake/(Total Validator Stake + Total Stake)`.
  - Let `Aux` be `((2^31 * Pool Stake)/Total Stake) + (2^31 * Validator Stake(i)) / Total Validator Stake`
    - TODO: Is there a better name for this value?
  - Let `Aux2` be `Aux * Target Reward(n) * Performance Factor(n)`, which is smaller than `2^(104)`.
    - TODO: Is there a better name for this value? Or could we combine both of the aux values into a single formula? I
      guess it's important to communicate that the value is `< 2^104`?
  - Let `Slot Pool Reward(n)` be `(Aux2 >> 40) - Fixed Cost`, which is smaller than `2^(64)`.
- To combine the `Slot Pool Rewards(n)` for each slot index `n` in the epoch into an epoch's `Pool Rewards`:
  - If any `Slot Pool Rewards(n) < 0` no entry for the epoch is added to the `Epoch Rewards`.
  - Otheriwse:
    - Let `Pool Rewards` be defined by the following decaying algorithm:
      - Let `m` and `M` be the first and last slot of the epoch, respectively.
      - TODO: I think we have to state this in non-pseudocode as the semantics are not 100% clearly defined.
      ```
      Pool Rewards = 0
      for n = m, ..., M-1:
          Pool Rewards = Pool Rewards + Slot Pool Rewards(n)
          Pool Rewards = Pool Rewards * 4294966388
          Pool Rewards = Pool Rewards >> 32
      Pool Rewards = Pool Rewards + Slot Pool Rewards(M)
      ```

## Validator Rewards

An account with a _Staking Feature_ can claim rewards in the same transaction where the feature is removed. The
transaction validation rules for removing the feature are defined in TIP-42. Upon removal, the amount of Mana that can
be claimed is defined as follows.

- Let the `Claimable Rewards` be all reward entries for the validator identified by the Account ID of the account that
  removes the Staking Feature, where the entry's `Epoch Index` satisfies `Epoch Index >= Start Epoch + 1` and
  `Epoch Index < Current Transaction Epoch Index`, where:
- Let the total claimable rewards be the sum of `Rewards(n)` for an epoch index `n`, where:
  - Let `Profit Margin(n)` be the `Profit Margin` for epoch index `n`.
  - Let `Pool Rewards(n)` be the `Pool Rewards` of the entry in `Claimable Rewards` with epoch index `n`.
  - Let `Pool Stake(n)` be the `Pool Stake` of the entry in `Claimable Rewards` with epoch index `n`.
  - Let `Fixed Cost` be the `Fixed Cost` defined in the _Staking Feature_.
  - Let `Undecayed Rewards(n)` be
    `Fixed Cost + ((Profit Margin(n) * Pool Rewards(n)) >> 8) + (((2^8 - Profit Margin(n)) * Pool Rewards(n)) >> 8) * Staked Amount/Pool Stake(n)`.
  - Let `Rewards (n)` be `(Undecayed Rewards(n) * decay(d * 8640)) >> 32`, where
    `d = Current Transaction Epoch Index - n`.

## Delegation Rewards

To claim rewards, a _Delegation Output_ must be destroyed. Depending on the state it is in at that point, different
conditions for claiming rewards apply. An output destroyed in _Delegating State_ will always forfeit _potential_ rewards
for the epoch in which it is destroyed, since the rewards for that epoch only become available in the next epoch. They
are _potential_ since the validator to which the output is delegating may not have been selected into the commitee for
that epoch.

The amount of Mana that can be claimed for a _Delegation Output_ which is destroyed are defined as follows.

- Let the `Claimable Rewards` be all reward entries for the validator identified by the Account ID `Validator ID` field
  in the output, where its `Epoch Index` satisfies `Epoch Index >= Start Epoch` and `Epoch Index < Delegation End`,
  where:
  - If the output is in _Delegating State_ let `Delegation End` be `Current Transaction Epoch Index - 1` (TODO: We could
    do without `-1`, technically).
    - Note that no transaction validation rule exists to prevent claiming rewards before the rewards of the previous
      epoch became available, thus forfeiting the potential rewards of that previous epoch.
  - If the output is in _Delayed Claiming State_ let `Delegation End` be `End Epoch`.
- Let the total claimable rewards be the sum of `Rewards(n)` for an epoch index `n`, where:
  - Let `Profit Margin(n)` be the `Profit Margin` for epoch index `n`.
  - Let `Pool Rewards(n)` be the `Pool Rewards` of the entry in `Claimable Rewards` with epoch index `n`.
  - Let `Pool Stake(n)` be the `Pool Stake` of the entry in `Claimable Rewards` with epoch index `n`.
  - Let `Undecayed Rewards(n)` be
    `(((2^8 - Profit Margin(n)) * Pool Rewards(n)) >> 8) * Delegated Amount/Pool Stake(n)`.
  - Let `Rewards (n)` be `(Undecayed Rewards(n) * decay(d * 8640)) >> 32`, where
    `d = Current Transaction Epoch Index - n`.

# Copyright

Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/).
